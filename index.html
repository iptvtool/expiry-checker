<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Expiry Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg:#f7f7f7; --card:#ffffff; --text:#111111; --muted:#666666; --border:#cccccc;
      --btn:#111111; --btnText:#ffffff; --resultBg:#f0f0f0; --shadow:0 4px 14px rgba(0,0,0,0.08);
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#f1f3f5; --muted:#a9b0bb; --border:#2b303a;
      --btn:#f1f3f5; --btnText:#111111; --resultBg:#11141a; --shadow:0 8px 22px rgba(0,0,0,0.40);
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;display:flex;justify-content:center}
    .card{background:var(--card);padding:22px;max-width:560px;width:100%;border-radius:12px;box-shadow:var(--shadow)}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    h1{margin:0 0 6px;font-size:22px;line-height:1.2}
    .disclaimer{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
    .toggle{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;white-space:nowrap}
    label{display:block;margin-top:14px;font-weight:600;font-size:14px}
    input{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:16px;box-sizing:border-box}
    .btnrow{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    button.primary{flex:1 1 220px;padding:12px;background:var(--btn);color:var(--btnText);border:none;border-radius:10px;font-size:16px;cursor:pointer}
    button.secondary{flex:1 1 140px;padding:12px;background:transparent;color:var(--text);border:1px solid var(--border);border-radius:10px;font-size:14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .result{margin-top:16px;padding:12px;border-radius:10px;background:var(--resultBg);border:1px solid var(--border);white-space:pre-wrap;font-size:14px;min-height:52px}
    .ok{color:#0aa07a;font-weight:800}
    .bad{color:#d24545;font-weight:800}
    .warn{color:#c78a00;font-weight:800}
    .hint{color:var(--muted);font-size:12px;margin-top:10px}
    .notice{color:#0aa07a;font-size:12px;margin-top:6px;display:none}
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <div>
        <h1>Expiry Checker</h1>
        <p class="disclaimer">Runs in your browser only. Nothing is stored or sent anywhere except to the IPTV server you enter.</p>
      </div>
      <button id="themeBtn" class="toggle" type="button">Dark mode</button>
    </div>

    <label>Server URL</label>
    <input id="server" placeholder="cf.example.com" value="https://cf.1575-cdn.me" autocomplete="url">
    <div id="notice" class="notice">Switched to HTTPS for browser compatibility.</div>

    <label>Username</label>
    <input id="username" placeholder="username" autocomplete="username">

    <label>Password</label>
    <input id="password" type="password" placeholder="password" autocomplete="current-password">

    <div class="btnrow">
      <button id="checkBtn" class="primary" type="button">Check expiry</button>
      <button id="copyBtn" class="secondary" type="button">Copy result</button>
      <button id="resetBtn" class="secondary" type="button">Reset</button>
    </div>

    <div id="output" class="result">Ready.</div>
    <div class="hint">
      Note: If a provider is truly HTTP-only, a GitHub Pages site can’t query it in-page due to browser security rules.
    </div>
  </div>

<script>
(function(){
  var out = document.getElementById("output");
  var btn = document.getElementById("checkBtn");
  var copyBtn = document.getElementById("copyBtn");
  var resetBtn = document.getElementById("resetBtn");
  var themeBtn = document.getElementById("themeBtn");
  var serverInput = document.getElementById("server");
  var notice = document.getElementById("notice");

  var lastResultText = "";

  function trim(v){ return (v || "").trim(); }
  function showNotice(){
    notice.style.display = "block";
    setTimeout(function(){ notice.style.display = "none"; }, 2000);
  }

  function normalizeToHttps(input){
    var v = trim(input);
    if (!v) return "";

    var lower = v.toLowerCase();

    // Strip scheme if present
    if (lower.startsWith("http://")) {
      v = v.slice(7);
      showNotice();
    } else if (lower.startsWith("https://")) {
      v = v.slice(8);
    } else {
      // bare host — still force https
    }

    // Strip path/query
    var slash = v.indexOf("/");
    if (slash !== -1) v = v.slice(0, slash);

    v = v.replace(/\/+$/, "");
    return "https://" + v;
  }

  serverInput.addEventListener("paste", function(){
    setTimeout(function(){ serverInput.value = normalizeToHttps(serverInput.value); }, 0);
  });
  serverInput.addEventListener("blur", function(){
    serverInput.value = normalizeToHttps(serverInput.value);
  });

  function setOutputText(t){ lastResultText = t; out.textContent = t; }
  function setOutputHTML(html, plain){ lastResultText = plain || ""; out.innerHTML = html; }

  function unixToLocal(secStr){
    var n = parseInt(secStr, 10);
    if (!isFinite(n)) return null;
    var d = new Date(n * 1000);
    if (isNaN(d.getTime())) return null;
    return d;
  }

  function applyTheme(theme){
    if (theme === "dark") document.body.classList.add("dark");
    else document.body.classList.remove("dark");
    themeBtn.textContent = document.body.classList.contains("dark") ? "Light mode" : "Dark mode";
  }
  try { applyTheme(localStorage.getItem("expiry_checker_theme") || "light"); } catch(e){ applyTheme("light"); }
  themeBtn.addEventListener("click", function(){
    var nowDark = !document.body.classList.contains("dark");
    applyTheme(nowDark ? "dark" : "light");
    try { localStorage.setItem("expiry_checker_theme", nowDark ? "dark" : "light"); } catch(e) {}
  });

  resetBtn.addEventListener("click", function(){
    serverInput.value = "https://cf.1575-cdn.me";
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
    setOutputText("Ready.");
  });

  copyBtn.addEventListener("click", async function(){
    var text = trim(lastResultText || out.textContent || "");
    if (!text) text = "No result to copy.";
    try {
      await navigator.clipboard.writeText(text);
      setOutputText("Copied result to clipboard.\n\n" + text);
    } catch(e) {
      setOutputText("Could not access clipboard. Please select and copy manually.\n\n" + text);
    }
  });

  function connMessage(activeCons, maxCons){
    if (activeCons === null || maxCons === null) {
      return { html:"<b>Connections:</b> Unknown<br>", text:"Connections: Unknown\n" };
    }
    var a = parseInt(activeCons, 10), m = parseInt(maxCons, 10);
    if (!isFinite(a) || !isFinite(m)) {
      return { html:"<b>Connections:</b> Unknown<br>", text:"Connections: Unknown\n" };
    }
    var reached = (m > 0 && a >= m);
    var statusHtml = reached ? '<span class="warn">LIMIT REACHED</span>' : '<span class="ok">OK</span>';
    return {
      html: "<b>Connections:</b> " + a + " active / " + m + " max — " + statusHtml + "<br>",
      text: "Connections: " + a + " active / " + m + " max — " + (reached ? "LIMIT REACHED" : "OK") + "\n"
    };
  }

  async function check(){
    btn.disabled = true;
    setOutputText("Checking…");

    try {
      var server = normalizeToHttps(serverInput.value);
      serverInput.value = server;

      var user = trim(document.getElementById("username").value);
      var pass = trim(document.getElementById("password").value);

      if (!server || !user || !pass){
        setOutputText("Please fill in Server URL, Username and Password.");
        return;
      }

      server = server.replace(/\/+$/, "");

      var url = server + "/player_api.php?username=" + encodeURIComponent(user) +
                "&password=" + encodeURIComponent(pass) + "&_=" + Date.now();

      var res = await fetch(url, { method: "GET", cache: "no-store" });
      var text = await res.text();

      if (!res.ok){
        setOutputText("HTTP " + res.status + " " + res.statusText + "\n\n" + text.slice(0, 600));
        return;
      }

      var data;
      try {
        text = (text || "").replace(/^\uFEFF/, "").trim();
        data = JSON.parse(text);
      } catch(e) {
        setOutputText("Response was not valid JSON (often a block/HTML page).\n\n" + text.slice(0, 600));
        return;
      }

      var ui = (data && data.user_info) ? data.user_info : null;
      var exp = (ui && ui.exp_date) ? ui.exp_date : null;
      var status = (ui && ui.status) ? ui.status : "Unknown";
      var activeCons = (ui && ui.active_cons !== undefined) ? ui.active_cons : null;
      var maxCons = (ui && ui.max_connections !== undefined) ? ui.max_connections : null;

      if (!exp || exp === "0"){
        setOutputText("Could not find user_info.exp_date in response.\n\n" + text.slice(0, 600));
        return;
      }

      var expiryDate = unixToLocal(exp);
      if (!expiryDate){
        setOutputText("exp_date found but could not convert: " + exp);
        return;
      }

      var days = Math.floor((expiryDate.getTime() - Date.now()) / 86400000);
      var active = days >= 0;
      var conn = connMessage(activeCons, maxCons);

      var plain =
        "Status: " + (active ? "ACTIVE" : "EXPIRED") + "\n" +
        "API status: " + status + "\n" +
        "Server used: " + server + "\n" +
        conn.text +
        "Expiry date: " + expiryDate.toLocaleString() + "\n" +
        "Days remaining: " + days;

      var html =
        "<b>Status:</b> " + (active ? '<span class="ok">ACTIVE</span>' : '<span class="bad">EXPIRED</span>') + "<br>" +
        "<b>API status:</b> " + status + "<br>" +
        "<b>Server used:</b> " + server + "<br>" +
        conn.html +
        "<b>Expiry date:</b> " + expiryDate.toLocaleString() + "<br>" +
        "<b>Days remaining:</b> " + days;

      setOutputHTML(html, plain);

    } catch(e) {
      setOutputText(
        "Error: " + (e && e.message ? e.message : String(e)) + "\n\n" +
        "If this server is HTTP-only, the browser will block it from this HTTPS site. Try an HTTPS CDN/domain."
      );
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", check);
})();
</script>

</body>
</html>
